<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="iiwa1">

  <xacro:macro name="iiwa_macro" params="parent prefix *origin">

    <material name="${prefix}gray">
      <color rgba="0.5 0.5 0.5 1.0"/>
    </material>

    <link name="${prefix}iiwa_base"/>

    <joint name="${prefix}iiwa_root_joint" type="fixed">
      <xacro:insert_block name="origin" />
      <parent link="${parent}"/>
      <child link="${prefix}iiwa_base"/>
    </joint>

    <joint name="${prefix}iiwa_base_joint" type="fixed">
      <origin rpy="0.0 0 0" xyz="0 0 0"/>
      <parent link="${prefix}iiwa_base"/>
      <child link="${prefix}link_0"/>
    </joint>

    <link name="${prefix}link_0">
      <visual>
        <origin rpy="0.0 0 0" xyz="0 0 0"/>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/base_link.dae"/></geometry>
      </visual>
      <collision>
        <origin rpy="0 0 0" xyz="0 0 0.05"/>
        <geometry><cylinder radius="0.08" length="0.1"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0.05" rpy="0 0 0"/>
        <mass value="5"/>
        <inertia ixx="0.05" ixy="0" ixz="0" iyy="0.06" iyz="0" izz="0.03"/>
      </inertial>
    </link>

    <link name="${prefix}link_1">
      <visual>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_1.dae"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0.01" rpy="0 0 0"/>
        <geometry><cylinder radius="0.06" length="0.36"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0.01" rpy="0 0 0"/>
        <mass value="4"/>
        <inertia ixx="0.05" ixy="0" ixz="0" iyy="0.05" iyz="0" izz="0.005"/>
      </inertial>
    </link>

    <link name="${prefix}link_2">
      <visual>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_2.dae"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0.04 0" rpy="0 0 0"/>
        <geometry><cylinder radius="0.055" length="0.1"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0.04 0" rpy="0 0 0"/>
        <mass value="4"/>
        <inertia ixx="0.04" ixy="0" ixz="0" iyy="0.005" iyz="0" izz="0.04"/>
      </inertial>
    </link>

    <link name="${prefix}link_3">
      <visual>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_3.dae"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0.21" rpy="0 0 0"/>
        <geometry><cylinder radius="0.055" length="0.42"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0.21" rpy="0 0 0"/>
        <mass value="3"/>
        <inertia ixx="0.06" ixy="0" ixz="0" iyy="0.06" iyz="0" izz="0.004"/>
      </inertial>
    </link>

    <link name="${prefix}link_4">
      <visual>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_4.dae"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0.04 0" rpy="0 0 0"/>
        <geometry><cylinder radius="0.05" length="0.1"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0.04 0" rpy="0 0 0"/>
        <mass value="2.7"/>
        <inertia ixx="0.025" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.025"/>
      </inertial>
    </link>

    <link name="${prefix}link_5">
      <visual>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_5.dae"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0.2" rpy="0 0 0"/>
        <geometry><cylinder radius="0.045" length="0.4"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0.2" rpy="0 0 0"/>
        <mass value="1.7"/>
        <inertia ixx="0.03" ixy="0" ixz="0" iyy="0.03" iyz="0" izz="0.002"/>
      </inertial>
    </link>

    <link name="${prefix}link_6">
      <visual>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_6.dae"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry><cylinder radius="0.04" length="0.08"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0.04" rpy="0 0 0"/>
        <mass value="1.8"/>
        <inertia ixx="0.015" ixy="0" ixz="0" iyy="0.015" iyz="0" izz="0.002"/>
      </inertial>
    </link>

    <link name="${prefix}link_7">
      <visual>
        <origin rpy="0 0 0" xyz="0 0 0.07"/>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_7_2.stl" scale="0.001 0.001 0.001"/></geometry>
        <material name="${prefix}gray"/>
      </visual>
      <collision>
        <origin rpy="0 0 0" xyz="0 0 0.077"/>
        <geometry><cylinder radius="0.035" length="0.154"/></geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0.077" rpy="0 0 0"/>
        <mass value="0.43"/>
        <inertia ixx="0.002" ixy="0" ixz="0" iyy="0.002" iyz="0" izz="0.0005"/>
      </inertial>
    </link>

    <link name="${prefix}tool0"/>

    <joint name="${prefix}joint_a1" type="revolute">
      <origin rpy="0 0 0" xyz="0 0 0.01"/>
      <parent link="${prefix}link_0"/><child link="${prefix}link_1"/>
      <axis xyz="0 0 1"/>
      <limit effort="320" lower="-2.9668" upper="2.9668" velocity="1.4834"/>
      <dynamics damping="5.0" friction="1.0"/>
    </joint>

    <joint name="${prefix}joint_a2" type="revolute">
      <origin rpy="0 0 0" xyz="0 0 0.36"/>
      <parent link="${prefix}link_1"/><child link="${prefix}link_2"/>
      <axis xyz="0 1 0"/>
      <limit effort="320" lower="-2.0942" upper="2.0942" velocity="1.4834"/>
      <dynamics damping="5.0" friction="1.0"/>
    </joint>

    <joint name="${prefix}joint_a3" type="revolute">
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <parent link="${prefix}link_2"/><child link="${prefix}link_3"/>
      <axis xyz="0 0 1"/>
      <limit effort="176" lower="-2.9668" upper="2.9668" velocity="1.7452"/>
      <dynamics damping="5.0" friction="1.0"/>
    </joint>

    <joint name="${prefix}joint_a4" type="revolute">
      <origin rpy="0 0 0" xyz="0 0 0.42"/>
      <parent link="${prefix}link_3"/><child link="${prefix}link_4"/>
      <axis xyz="0 -1 0"/>
      <limit effort="176" lower="-2.0942" upper="2.0942" velocity="1.3089"/>
      <dynamics damping="5.0" friction="1.0"/>
    </joint>

    <joint name="${prefix}joint_a5" type="revolute">
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <parent link="${prefix}link_4"/><child link="${prefix}link_5"/>
      <axis xyz="0 0 1"/>
      <limit effort="110" lower="-2.9668" upper="2.9668" velocity="2.2688"/>
      <dynamics damping="3.0" friction="0.5"/>
    </joint>

    <joint name="${prefix}joint_a6" type="revolute">
      <origin rpy="0 0 0" xyz="0 0 0.4"/>
      <parent link="${prefix}link_5"/><child link="${prefix}link_6"/>
      <axis xyz="0 1 0"/>
      <limit effort="40" lower="-2.0942" upper="2.0942" velocity="2.356"/>
      <dynamics damping="3.0" friction="0.5"/>
    </joint>

    <joint name="${prefix}joint_a7" type="revolute">
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <parent link="${prefix}link_6"/><child link="${prefix}link_7"/>
      <axis xyz="0 0 1"/>
      <limit effort="40" lower="-3.0541" upper="3.0541" velocity="2.356"/>
      <dynamics damping="2.0" friction="0.3"/>
    </joint>

    <joint name="${prefix}joint_a7-tool0" type="fixed">
      <origin rpy="0 0 0" xyz="0 0 0.154"/>
      <parent link="${prefix}link_7"/><child link="${prefix}tool0"/>
    </joint>
    
    <link name="${prefix}vacuum_gripper_link">
      <visual>
        <origin xyz="0 0 0.01" rpy="0 0 0"/>
        <geometry><cylinder radius="0.04" length="0.02"/></geometry>
        <material name="Black"><color rgba="0.1 0.1 0.1 1"/></material>
      </visual>
      <collision name="${prefix}vacuum_gripper_collision">
        <origin xyz="0 0 0.01" rpy="0 0 0"/>
        <geometry><cylinder radius="0.04" length="0.02"/></geometry>
      </collision>
      <inertial>
        <mass value="0.1"/>
        <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
      </inertial>
    </link>

    <joint name="${prefix}vacuum_gripper_joint" type="fixed">
      <parent link="${prefix}tool0"/>
      <child link="${prefix}vacuum_gripper_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </joint>
    
    <gazebo reference="${prefix}vacuum_gripper_link">
      <sensor name="suction_contact" type="contact">
        <contact>
          <collision>${prefix}vacuum_gripper_collision</collision>
        </contact>
        <update_rate>30</update_rate>
        <always_on>true</always_on>
      </sensor>
    </gazebo>

    <gazebo reference="${prefix}vacuum_gripper_joint">
      <preserveFixedJoint>true</preserveFixedJoint>
      <disableFixedJointLumping>true</disableFixedJointLumping> 
    </gazebo>

  </xacro:macro>

  <link name="world"/>
  <xacro:iiwa_macro parent="world" prefix="iiwa_">
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </xacro:iiwa_macro>

  <ros2_control name="iiwa1_hardware" type="system">
    <hardware><plugin>gz_ros2_control/GazeboSimSystem</plugin></hardware>
    <joint name="iiwa_joint_a1"><command_interface name="position"/><state_interface name="position"/><state_interface name="velocity"/></joint>
    <joint name="iiwa_joint_a2"><command_interface name="position"/><state_interface name="position"/><state_interface name="velocity"/></joint>
    <joint name="iiwa_joint_a3"><command_interface name="position"/><state_interface name="position"/><state_interface name="velocity"/></joint>
    <joint name="iiwa_joint_a4"><command_interface name="position"/><state_interface name="position"/><state_interface name="velocity"/></joint>
    <joint name="iiwa_joint_a5"><command_interface name="position"/><state_interface name="position"/><state_interface name="velocity"/></joint>
    <joint name="iiwa_joint_a6"><command_interface name="position"/><state_interface name="position"/><state_interface name="velocity"/></joint>
    <joint name="iiwa_joint_a7"><command_interface name="position"/><state_interface name="position"/><state_interface name="velocity"/></joint>
  </ros2_control>
  
  <gazebo>
    <plugin filename="libignition-gazebo-detachable-joint-system.so"
            name="ignition::gazebo::systems::DetachableJoint">
      <parent_link>iiwa_vacuum_gripper_link</parent_link>
      <child_model>package</child_model>
      <child_link>package_link</child_link>
      <output_topic>/iiwa1/gripper/state_package</output_topic>
      <detach_topic>/iiwa1/gripper/detach_package</detach_topic>
      <attach_topic>/iiwa1/gripper/attach_package</attach_topic>
    </plugin>
  </gazebo>
  <gazebo>
    <plugin filename="libignition-gazebo-detachable-joint-system.so"
            name="ignition::gazebo::systems::DetachableJoint">
      <parent_link>iiwa_vacuum_gripper_link</parent_link>
      <child_model>package2</child_model>
      <child_link>package2_link</child_link>
      <output_topic>/iiwa1/gripper/state_package2</output_topic>
      <detach_topic>/iiwa1/gripper/detach_package2</detach_topic>
      <attach_topic>/iiwa1/gripper/attach_package2</attach_topic>
    </plugin>
  </gazebo>
  
  <gazebo>
    <plugin filename="libgz_ros2_control-system.so" name="gz_ros2_control::GazeboSimROS2ControlPlugin">
      <parameters>$(find iiwa_description)/config/iiwa1_controllers.yaml</parameters>
      <robot_param>robot_description</robot_param>
      <robot_param_node>robot_state_publisher</robot_param_node>
      <ros><namespace>iiwa</namespace></ros>
    </plugin>
  </gazebo>
</robot>